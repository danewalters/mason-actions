---
name: Test mason-registry
description: Test mason-registry package definitions.

inputs:
  target:
    required: true
    description: The target platform to test (e.g. "darwin_x64").
  log_level:
    required: false
    description: Log level.
    default: INFO
  packages:
    required: true
    description: The packages to test (space separated string).

runs:
  using: composite
  steps:
    - if: ${{ runner.os == 'macOS' }}
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'

    - shell: bash
      run: |
        git clone https://github.com/williamboman/mason.nvim "$GITHUB_ACTION_PATH/mason.nvim"
        git -C "$GITHUB_ACTION_PATH/mason.nvim" fetch origin static-registry
        git -C "$GITHUB_ACTION_PATH/mason.nvim" checkout FETCH_HEAD

    - name: Download yq
      shell: bash
      run: python3 -m pip install yq

    - uses: rhysd/action-setup-vim@v1
      with:
        neovim: true
        version: v0.8.0

    - run: nvim --headless -c "luafile $GITHUB_ACTION_PATH/test-runner.lua" -c 1cq
      shell: bash
      env:
        PACKAGES: ${{ inputs.packages }}
        TARGET: ${{ inputs.target }}
        LOG_LEVEL: ${{ inputs.log_level }}
